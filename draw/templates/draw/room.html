{% load static %}

<!DOCTYPE html>
<html class="mx-5 mb-0">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>P4 Drawing</title>

    <link rel="stylesheet" type="text/css" href="{% static 'draw/vendor/bootstrap/css/bootstrap.min.css' %}">
    <link rel="stylesheet" type="text/css" href="{% static 'draw/style.css' %}" />

    <script type="text/javascript" src="{% static 'draw/vendor/jquery/jquery-3.3.1.min.js' %}"></script>
    <script type="text/javascript" src="{% static 'draw/vendor/paper/paper-full.min.js' %}"></script>

</head>
<body class="bg-secondary" onload="checkmsg()">
  <h1 class="m-5 p-5 text-center border border-dark rounded bg-warning">Caravan</h1>
  <div class="container-flex" id = "board">
    <div class="row">
      <div class="col ml-3">
        <h2 class="py-5 text-center border border-dark rounded bg-warning">Recommendations!</h2>

      <div class="container-flex">
        <div class="row no-gutters">
          <div class="col-6 flex-column">
            <div class="sticky-note">OK</div>
            <div class="sticky-note">i kinda went sicko mode</div>
          </div>
          <div class="col-6 flex-column">
            <div class="sticky-note">sorry</div>
            <div class="sticky-note">that mb</div>
          </div>
        </div>
      </div>

      </div>
      <div class="col">
        <h2 class="py-5 text-center border border-dark rounded bg-warning">How was your experience?</h2>

        <div class="container-flex">
          <div class="row no-gutters">
            <div class="col-6 flex-column">
              <div class="sticky-note">but hey</div>
              <div class="sticky-note">it works</div>
            </div>
            <div class="col-6 flex-column">
              <div class="sticky-note">it looks ok</div>
              <div class="sticky-note">no?</div>
            </div>
          </div>
        </div>

      </div>
      <div class="col mr-3">
        <h2 class="py-5 text-center border border-dark rounded bg-warning">Anything you want!</h2>

        <div class="container-flex">
          <div class="row no-gutters">
            <div class="col-6 flex-column">
              <div class="sticky-note">i know</div>
              <div class="sticky-note">the amount of bootstrap</div>
            </div>
            <div class="col-6 flex-column">
              <div class="sticky-note">hard to read</div>
              <div class="sticky-note">just msg me if you have questions</div>
            </div>
          </div>
        </div>

      </div>
    </div>

    <!-- <div class="row">
      <div class="col d-flex justify-content-center">
        <div class="sticky-note"></div>
        <div class="sticky-note"></div>

      </div>
      <div class="col d-flex justify-content-center">
        <div class="sticky-note"></div>
        <div class="sticky-note"></div>

      </div>
      <div class="col d-flex justify-content-center">
        <div class="sticky-note"></div>
        <div class="sticky-note"></div>

      </div>
    </div> -->
  </div>

  <form action="" method="GET" id="form" onsubmit="submitting()">
    <div class="formelem">
      <label for="msg">Message:</label>
      <textarea id="msg" name="user_message"></textarea>
    </div>
    <div class="formelem">
      <input type="submit" value="Send">
    </div>
  </form>

  <div id="new">

  </div>


</body>
<script>
  var searchParams = new URLSearchParams(window.location.search);
  var uid = Date.now() % 10000;
  var noteList = new Map();
  var small = true;

  

  var socket = new WebSocket(
      'ws://' + window.location.host + '/ws/draw');

  for (const [key, value] of searchParams) {
    if (key == "display") {
      if (value == "large") {
        let form = document.getElementById("form");
        small = false;
        form.style.display = "none";
      }
      if (value == "small") {
        let board = document.getElementById("board");
        board.style.display = "none";
      }
    }
  }

  if (small == true) {
    let board = document.getElementById("board");
    board.style.display = "none";
  }

  function checkmsg() {
    for (const [key, value] of searchParams) {
    
    if (key == "user_message") {
      console.log("\nkey: " + key + "\nvalue: " + value);
      noteList.set(uid, value);
      console.log(noteList);
      socket.onopen = () => socket.send("{\"text\" : " + JSON.stringify(noteList.get(uid)) + ", \"uid\" : " + uid + "}" );
      // socket.send("{\"uid\" : " + uid + "}" );
      console.log("socket sending");
    }
  }
  }

  function submitting() {
    // socket.send("{\"text\" : " + noteList.get(uid).toString() + ", \"uid\" : " + uid + "}" );
    // socket.send("{\"uid\" : " + uid + "}" );
    // console.log(noteList);
  }
  
  //is called everytime message is received
  socket.onmessage = function(receivedMessage) {
    var received = JSON.parse(receivedMessage.data);
    console.log(received);
    
    console.log("socket receiving");
    if (!noteList.has(received.uid)) {
      noteList.set(received.uid, received.text);
    }
    
    console.log(noteList);

    var tag = document.createElement("p");
    var message = document.createTextNode(noteList.get(received.uid));
    tag.appendChild(message);
    var element = document.getElementById("new");
    element.appendChild(tag);

  }

  socket.onclose = function(e) {
      console.error('Chat socket closed unexpectedly');
  };

</script>
</html>
